(()=>{"use strict";var e={n:t=>{var a=t&&t.__esModule?()=>t.default:()=>t;return e.d(a,{a}),a},d:(t,a)=>{for(var n in a)e.o(a,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:a[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.wp.element,a=window.wp.i18n,n=window.wp.htmlEntities,r=window.wp.data,o=window.wc.wcSettings,p=window.wc.wcBlocksRegistry,i=window.React,l=window.jQuery;var s=e.n(l);const c=(0,o.getSetting)("apple_pay_data",{}),d=(0,o.getSetting)("apple_pay_data",{}),u=e=>{let a=null,n=null;const r=jQuery("#apple-pay-button-wrapper"),o={load_order_total:!1,OrderPaymentCreated:function(e){"success"!==e.payment_data.result&&o.CancelOrder(),o.BeginSession(e)},CreateSession:function(){const e={countryCode:d.countryCode,currencyCode:d.currencyCode,merchantCapabilities:["supports3DS"],supportedNetworks:["visa","masterCard"],total:{label:"Apple Pay",type:"final",amount:d.total_amount/100},applicationData:btoa(JSON.stringify({apple_pay_domain:d.apple_pay_domain})),requiredBillingContactFields:["postalAddress","name"],requiredShippingContactFields:["postalAddress","name","phone","email"]};d.payplug_apple_pay_shipping_required&&(e.shippingMethods=d.payplug_carriers),a=new ApplePaySession(3,e)},CancelOrder:function(){a.oncancel=e=>{var t;(t={order_id:a.order_id,payment_id:a.payment_id},new Promise(((e,a)=>{s().ajax({type:"POST",data:t,url:c.ajax_url_applepay_cancel_order}).success((function(t){e(t)})).error((function(e,t,n){a(n)}))}))).then((()=>{p()}))}},BeginSession:function(e){a.payment_id=e.payment_data.payment_id,a.order_id=e.order_id,a.cancel_url=e.payment_data.cancel_url,a.return_url=e.payment_data.return_url,o.MerchantValidated(a,e.payment_data.merchant_session),a.amount=100*parseFloat(d.total/100),a.onshippingmethodselected=e=>{const t=e.shippingMethod;a.shippingMethod=t.identifier;const n=d.total/100;let r=t.amount;const o=parseFloat(n)+parseFloat(r);a.amount=100*o;const p={newTotal:{label:"Total",amount:o},newLineItems:[{label:t.label,type:"final",amount:r}]};a.completeShippingMethodSelection(p)},a.begin()},MerchantValidated:function(e,t){e.onvalidatemerchant=a=>{try{e.completeMerchantValidation(t)}catch(e){o.CancelOrder()}}},AddErrorMessage:function(e){r.append(jQuery('<div class="apple-pay-cart-notice"></div>').append("<span>"+e+"</span>"))},DeleteErrorMessage:function(){setTimeout((function(){jQuery(".apple-pay-cart-notice").contents().first().remove()}),4e3)}};function p(){jQuery("apple-pay-button").removeClass("isDisabled")}return jQuery((function(e){jQuery("apple-pay-button").on("click",(e=>{e.preventDefault(),e.stopImmediatePropagation(),jQuery("apple-pay-button").addClass("isDisabled"),o.CreateSession(),o.CancelOrder(),new Promise(((e,t)=>{s().ajax({type:"POST",data:undefined,url:c.ajax_url_place_order_with_dummy_data}).success((function(t){e(t)})).error((function(e,a,n){t(n)}))})).then((async e=>{if(!1===e.success)return o.AddErrorMessage(e.data.message),o.DeleteErrorMessage(),void p();d.total=e.total,o.OrderPaymentCreated(e),await new Promise(((e,t)=>{a.onpaymentauthorized=t=>{let r=t.payment,p={order_id:a.order_id,shipping:r.shippingContact,billing:r.billingContact,shipping_method:a.shippingMethod};(e=>new Promise(((t,a)=>{s().ajax({type:"POST",data:e,url:c.ajax_url_update_applepay_order}).success((function(e){t(e)})).error((function(e,t,n){a(n)}))})))(p).then((r=>{p={action:"applepay_update_payment",post_type:"POST",payment_id:a.payment_id,payment_token:t.payment.token,order_id:a.order_id,amount:a.amount},(e=>new Promise(((t,a)=>{s().ajax({type:"POST",data:e,url:c.ajax_url_update_applepay_payment}).success((function(e){t(e)})).error((function(e,t,n){a(n)}))})))(p).then((t=>{n=ApplePaySession.STATUS_SUCCESS,!0!==t.success&&(n=ApplePaySession.STATUS_FAILURE,o.AddErrorMessage(t.data.message),o.DeleteErrorMessage(),o.CancelOrder()),a.completePayment({status:n}),e()}))}))}})).then((e=>{window.location=a.return_url}))}))}))})),(0,t.createElement)(t.Fragment,null," ")},y=(0,o.getSetting)("apple_pay_data",{}),_=(0,a.__)("Gateway method title","payplug"),m=(0,n.decodeEntities)(y?.title)||_,g=e=>{const{eventRegistration:a,emitResponse:n}=e,{onPaymentSetup:o,onCheckoutSuccess:p}=a,{CHECKOUT_STORE_KEY:l}=window.wc.wcBlocksData,d=(0,r.useSelect)((e=>e(l).getOrderId()));let u=null;(0,i.useEffect)((()=>{jQuery((function(e){e("form .wp-block-woocommerce-checkout-actions-block .wc-block-components-button").on("click",(async e=>{e.preventDefault(),_.CreateSession(),_.CancelOrder()}))}))}),[]),(0,i.useEffect)((()=>{const e=o((async()=>{await((e,t)=>{const a={order_id:t,"woocommerce-process-checkout-nonce":c.wp_nonce,gateway:"apple_pay"};return new Promise(((e,t)=>s().ajax({type:"POST",data:a,url:c.payplug_create_intent_payment}).success((function(t){e(t)})).error((function(e){t(e)}))))})(0,d).then((async e=>{await _.BeginSession(e)})).then((async e=>({type:"success"})))}));return()=>{e()}}),[o,n.noticeContexts.PAYMENTS,n.responseTypes.ERROR,n.responseTypes.SUCCESS]),(0,i.useEffect)((()=>{const e=p((async({processingResponse:{paymentDetails:e}})=>{var t;let a={};return await new Promise(((e,a)=>{u.onpaymentauthorized=async a=>{let n={action:"applepay_update_payment",post_type:"POST",payment_id:u.payment_id,payment_token:a.payment.token,order_id:u.order_id};await(e=>new Promise(((t,a)=>{s().ajax({type:"POST",data:e,url:c.ajax_url_applepay_update_payment}).success((function(e){t(e)})).error((function(e,t,n){a(n)}))})))(n).then((a=>{t=ApplePaySession.STATUS_SUCCESS,!0!==a.success&&(t=ApplePaySession.STATUS_FAILURE),u.completePayment({status:t}),e()}))}})).then((()=>{a={type:"success",redirectUrl:u.return_url}})),a}));return()=>{e()}}),[p]);let _={CreateSession:function(){const t={countryCode:y.payplug_countryCode,currencyCode:y.payplug_currencyCode,merchantCapabilities:["supports3DS"],supportedNetworks:["visa","masterCard"],supportedTypes:["debit","credit"],total:{label:"Apple Pay",type:"final",amount:e.billing.cartTotal.value/100},applicationData:btoa(JSON.stringify({apple_pay_domain:y.payplug_apple_pay_domain}))};u=new ApplePaySession(3,t)},CancelOrder:function(){u.oncancel=e=>{window.location=u.cancel_url}},BeginSession:function(e){u.payment_id=e.data.payment_id,u.order_id=d,u.cancel_url=e.data.cancel,u.return_url=e.data.redirect,_.MerchantValidated(u,e.data.merchant_session),u.begin()},MerchantValidated:function(e,t){e.onvalidatemerchant=async a=>{try{e.completeMerchantValidation(t)}catch(e){alert(e)}}}};return(0,t.createElement)(t.Fragment,null)},h=()=>(0,t.createElement)("img",{src:y?.icon.src,alt:y?.icon.icon_alt,className:"payplug-payment-icon",style:{float:"right"}}),w={name:"apple_pay",label:(0,t.createElement)((()=>(0,t.createElement)("span",{style:{width:"100%"}},m,(0,t.createElement)(h,null))),null),content:(0,t.createElement)(g,null),edit:(0,t.createElement)(g,null),canMakePayment:()=>!0,ariaLabel:m,supports:{features:y.supports}},S=e=>(0,t.createElement)(t.Fragment,null,(0,t.createElement)("div",{id:"apple-pay-button-wrapper"},(0,t.createElement)("apple-pay-button",{buttonstyle:"black",type:"pay",locale:y?.payplug_locale})),(0,t.createElement)(u,e)),f={name:"apple_pay",content:(0,t.createElement)(S,null),edit:(0,t.createElement)(S,null),canMakePayment:e=>{if(!y?.is_cart)return!1;if(y.payplug_apple_pay_shipping_required=e.cartNeedsShipping,y.total_amount=e.cartTotals.total_price,!e.cartNeedsShipping)return!0;let t=e.selectedShippingMethods[0].split(":");y.payplug_carriers.forEach((function(e){e.identifier===t&&(e.selected=!0)}));let a=y?.payplug_authorized_carriers,n=e.selectedShippingMethods[0].split(":"),r=!1;return a.forEach((function(e){n[0]===e&&(r=!0)})),r},paymentMethodId:"apple_pay"};(0,p.registerExpressPaymentMethod)(f),(0,p.registerPaymentMethod)(w)})();